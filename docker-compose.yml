services:
  osint-tool:
    build: .
    container_name: digital-footprint-investigator

    # Map Streamlit port
    ports:
      - "8501:8501"

    # Mount current directory for live code updates
    volumes:
      - .:/app
      - ./reports:/app/reports
      - ./logs:/app/logs
      # Anonymous volumes prevent host-side dirs from shadowing container state
      - /app/.venv
      - /app/venv
      - /app/__pycache__
      - /app/.pytest_cache

    # Load environment variables from .env file
    env_file:
      - .env

    # Restart policy
    restart: unless-stopped
    shm_size: 2gb

  # Unit tests -- no running app required; execute with:
  #   docker compose run --rm unit-tests
  unit-tests:
    build: .
    container_name: osint-unit-tests
    volumes:
      - .:/app
      - /app/.venv
      - /app/venv
      - /app/__pycache__
      - /app/.pytest_cache
    env_file:
      - .env
    environment:
      - PYTHONPATH=.
    command: ["pytest", "tests/unit/", "-v", "--tb=short"]

  # UI (Playwright) tests -- waits for the app to pass its health check; execute with:
  #   docker compose run --rm tests
  tests:
    build: .
    container_name: osint-ui-tests
    volumes:
      - .:/app
      - ./reports:/app/reports
      - ./logs:/app/logs
      # Anonymous volumes prevent host-side dirs from shadowing container state
      - /app/.venv
      - /app/venv
      - /app/__pycache__
      - /app/.pytest_cache
    env_file:
      - .env
    environment:
      - PYTHONPATH=.
      - PLAYWRIGHT_BROWSERS_PATH=/ms-playwright
    command: ["pytest", "tests/ui/", "-m", "not integration", "-v", "--tb=short"]
    depends_on:
      osint-tool:
        condition: service_healthy
    shm_size: 2gb
